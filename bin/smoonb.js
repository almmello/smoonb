#!/usr/bin/env node

/**
 * smoonb - Complete Supabase backup and migration tool
 * 
 * CLI principal para backup e migra√ß√£o de projetos Supabase
 * EXPERIMENTAL VERSION - USE AT YOUR OWN RISK
 * 
 * Desenvolvido por: Goalmoon Tecnologia LTDA
 * Website: https://goalmoon.com
 */

const { Command } = require('commander');
const chalk = require('chalk');
const packageJson = require('../package.json');

// Importar m√≥dulos principais
const { commands, showBetaBanner, showQuickHelp } = require('../src/index');

// Criar inst√¢ncia do Commander
const program = new Command();

// Configura√ß√£o b√°sica do programa
program
  .name('smoonb')
  .description('Complete Supabase backup and migration tool - EXPERIMENTAL VERSION - USE AT YOUR OWN RISK')
  .version(packageJson.version, '-v, --version', 'display version number')
  .addHelpText('before', () => {
    showBetaBanner();
    return '';
  })
  .addHelpText('after', () => {
    return chalk.cyan.bold(`
üìã CONFIGURA√á√ÉO AUTOM√ÅTICA:
   smoonb config --init           # Cria ~/.smoonbrc com projectId, URLs, etc.
   # Edite o arquivo com suas credenciais Supabase
   smoonb backup                  # Funciona sem --project-id!

üìù EXEMPLO DE CONFIGURA√á√ÉO (.smoonbrc):
   {
     "supabase": {
       "projectId": "abc123def456",
       "url": "https://abc123def456.supabase.co",
       "serviceKey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
       "anonKey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
       "databaseUrl": "postgresql://postgres:[senha]@db.abc123def456.supabase.co:5432/postgres"
     },
     "backup": {
       "includeFunctions": true,
       "includeStorage": true,
       "includeAuth": true,
       "includeRealtime": true,
       "outputDir": "./backups"
     },
     "restore": {
       "cleanRestore": false,
       "verifyAfterRestore": true
     }
   }

üîß COMO CONFIGURAR:
   1. smoonb config --init
   2. Edite ~/.smoonbrc com suas credenciais
   3. smoonb backup (funciona automaticamente!)
`);
  });

// Comandos principais
program
  .command('backup')
  .description('Fazer backup completo do projeto Supabase')
  .option('-p, --project-id <id>', 'ID do projeto Supabase')
  .option('-o, --output <dir>', 'Diret√≥rio de sa√≠da do backup', './backup')
  .option('--include-functions', 'Incluir Edge Functions no backup', true)
  .option('--include-storage', 'Incluir Storage Objects no backup', true)
  .option('--include-auth', 'Incluir Auth Settings no backup', true)
  .option('--include-realtime', 'Incluir Realtime Settings no backup', true)
  .action(commands.backup);

program
  .command('restore')
  .description('Restaurar backup completo no projeto Supabase')
  .option('-p, --project-id <id>', 'ID do projeto Supabase destino')
  .option('-b, --backup-dir <dir>', 'Diret√≥rio do backup a ser restaurado')
  .option('--clean-restore', 'Limpar projeto antes da restaura√ß√£o', false)
  .option('--verify', 'Verificar restaura√ß√£o ap√≥s completar', true)
  .action(commands.restore);

program
  .command('secrets')
  .description('Gerenciar secrets do projeto Supabase')
  .option('export', 'Exportar secrets (sem commitar)')
  .option('import', 'Importar secrets no projeto alvo')
  .action(commands.secrets);

program
  .command('functions')
  .description('Gerenciar Edge Functions')
  .option('push', 'Deploy de Edge Functions')
  .option('pull', 'Baixar Edge Functions do projeto')
  .action(commands.functions);

program
  .command('check')
  .description('Checklist p√≥s-restore - verificar integridade')
  .option('-p, --project-id <id>', 'ID do projeto Supabase')
  .option('--verbose', 'Sa√≠da detalhada', false)
  .action(commands.check);

program
  .command('config')
  .description('Configurar credenciais e configura√ß√µes do smoonb')
  .option('--init', 'Inicializar configura√ß√£o')
  .option('--show', 'Mostrar configura√ß√£o atual')
  .action(commands.config);

// Tratamento de erros
program.on('command:*', function (operands) {
  console.error(chalk.red.bold('‚ùå Comando n√£o reconhecido:'), operands[0]);
  console.error(chalk.yellow('üí° Use'), chalk.cyan('smoonb --help'), chalk.yellow('para ver comandos dispon√≠veis'));
  process.exit(1);
});

// Tratamento de exce√ß√µes n√£o capturadas
process.on('uncaughtException', (error) => {
  console.error(chalk.red.bold('‚ùå Erro n√£o tratado:'), error.message);
  console.error(chalk.gray('Stack trace:'), error.stack);
  process.exit(1);
});

process.on('unhandledRejection', (reason, promise) => {
  console.error(chalk.red.bold('‚ùå Promise rejeitada n√£o tratada:'), reason);
  process.exit(1);
});

// Exibir informa√ß√µes do per√≠odo beta quando nenhum comando √© fornecido
if (process.argv.length === 2) {
  showBetaBanner();
  showQuickHelp();
}

// Parse dos argumentos da linha de comando
program.parse(process.argv);

// Se nenhum comando foi fornecido, mostrar ajuda
if (!process.argv.slice(2).length) {
  program.outputHelp();
}
