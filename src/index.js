/**
 * smoonb - Complete Supabase backup and migration tool
 * Entry point principal e exports dos m√≥dulos
 * 
 * Vers√£o: 0.1.0-beta (FREE BETA PERIOD)
 */

const chalk = require('chalk');
const { showBetaBanner } = require('./utils/banner');

// Exportar comandos
const backupCommand = require('./commands/backup');
const restoreCommand = require('./commands/restore');
const functionsCommand = require('./commands/functions');
const checkCommand = require('./commands/check');
const configCommand = require('./commands/config');

// Exportar utilit√°rios
const supabaseUtils = require('./utils/supabase');
const validationUtils = require('./utils/validation');

/**
 * Informa√ß√µes do pacote
 */
const packageInfo = {
  name: 'smoonb',
  description: 'Complete Supabase backup and migration tool - EXPERIMENTAL VERSION - USE AT YOUR OWN RISK',
  author: 'Goalmoon Tecnologia LTDA <https://goalmoon.com>',
  license: 'SEE LICENSE IN LICENSE.md'
};

/**
 * Informa√ß√µes de licenciamento
 */
function showLicenseInfo() {
  console.log(chalk.yellow.bold(`
üìã INFORMA√á√ïES DE LICENCIAMENTO:

üÜì VERS√ÉO EXPERIMENTAL GRATUITA (Vers√µes 0.x.x):
   ‚úÖ Uso gratuito para projetos pessoais e comerciais
   ‚úÖ Sem restri√ß√µes de funcionalidades
   ‚ùå SEM SUPORTE - apenas aceitamos contribui√ß√µes
   ‚ö†Ô∏è USE POR SUA CONTA E RISCO - software n√£o testado

üíº LICEN√áA COMERCIAL (Vers√µes 1.0.0+):
   ‚ö†Ô∏è  A partir da vers√£o 1.0.0, o smoonb ser√° licenciado comercialmente
   üìß Aviso pr√©vio: Mudan√ßas ser√£o anunciadas 90 dias antes
   üí∞ Desconto especial: Usu√°rios experimentais ter√£o condi√ß√µes preferenciais

üè¢ DESENVOLVIDO POR: Goalmoon Tecnologia LTDA
üåê Website: https://goalmoon.com

üìñ Leia a licen√ßa completa em: LICENSE.md
`));
}

/**
 * Informa√ß√µes de ajuda r√°pida
 */
function showQuickHelp() {
  console.log(chalk.cyan.bold(`
üöÄ COMANDOS PRINCIPAIS:

üìä Backup completo:
   npx smoonb backup                    # Usa configura√ß√£o do .smoonbrc

üîÑ Restaura√ß√£o completa:
   npx smoonb restore --backup-dir <dir>  # Restaura backup usando psql

‚ö° Edge Functions:
   npx smoonb functions list
   npx smoonb functions push

üîç Verifica√ß√£o p√≥s-restore:
   npx smoonb check                     # Verifica integridade do projeto

‚öôÔ∏è  Configura√ß√£o:
   npx smoonb config --init             # Criar arquivo de configura√ß√£o
   npx smoonb config --show             # Mostrar configura√ß√£o atual

üìã CONFIGURA√á√ÉO AUTOM√ÅTICA:
   npx smoonb config --init       # Cria .smoonbrc com projectId, URLs, etc.
   # Edite o arquivo com suas credenciais Supabase
   npx smoonb backup              # Funciona automaticamente!

üìù EXEMPLO DE CONFIGURA√á√ÉO (.smoonbrc):
   {
     "supabase": {
       "projectId": "abc123def456",
       "url": "https://abc123def456.supabase.co",
       "serviceKey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkXVCJ9...",
       "anonKey": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkXVCJ9...",
       "databaseUrl": "postgresql://postgres:[senha]@db.abc123def456.supabase.co:5432/postgres",
       "accessToken": "sbp_1234567890abcdef1234567890abcdef"
     }
   }

üîë PERSONAL ACCESS TOKEN (OBRIGAT√ìRIO):
   Para Management API (Edge Functions, Auth Settings, Storage):
   1. Acesse: https://supabase.com/dashboard/account/tokens
   2. Clique em "Generate new token"
   3. Copie o token (formato: sbp_...)
   4. Adicione ao .smoonbrc como "accessToken"

üîß COMO CONFIGURAR:
   1. npx smoonb config --init
   2. Edite .smoonbrc com suas credenciais
   3. npx smoonb backup (funciona automaticamente!)
`));
}

/**
 * Verificar pr√©-requisitos
 */
function checkPrerequisites() {
  const prerequisites = {
    node: { installed: true, version: process.version },
    npm: { installed: false, version: null },
    supabase_cli: { installed: false, version: null },
    pg_dump: { installed: false, version: null }
  };

  // Verificar npm
  try {
    const { execSync } = require('child_process');
    const npmVersion = execSync('npm --version', { encoding: 'utf8' }).trim();
    prerequisites.npm = { installed: true, version: npmVersion };
  } catch (error) {
    prerequisites.npm = { installed: false, version: null };
  }

  // Verificar Supabase CLI
  try {
    const { execSync } = require('child_process');
    const supabaseVersion = execSync('supabase --version', { encoding: 'utf8' }).trim();
    prerequisites.supabase_cli = { installed: true, version: supabaseVersion };
  } catch (error) {
    prerequisites.supabase_cli = { installed: false, version: null };
  }

  // Verificar pg_dump
  try {
    const { execSync } = require('child_process');
    const pgDumpVersion = execSync('pg_dump --version', { encoding: 'utf8' }).trim();
    prerequisites.pg_dump = { installed: true, version: pgDumpVersion };
  } catch (error) {
    prerequisites.pg_dump = { installed: false, version: null };
  }

  return prerequisites;
}

/**
 * Mostrar status dos pr√©-requisitos
 */
function showPrerequisitesStatus() {
  const prerequisites = checkPrerequisites();
  
  console.log(chalk.blue.bold('\nüìã Status dos Pr√©-requisitos:\n'));
  
  Object.entries(prerequisites).forEach(([name, info]) => {
    const icon = info.installed ? '‚úÖ' : '‚ùå';
    const status = info.installed ? chalk.green('Instalado') : chalk.red('N√£o instalado');
    const version = info.version ? chalk.gray(`(${info.version})`) : '';
    
    console.log(`  ${icon} ${chalk.cyan(name)}: ${status} ${version}`);
  });

  // Mostrar instru√ß√µes para instalar depend√™ncias faltantes
  const missing = Object.entries(prerequisites)
    .filter(([_, info]) => !info.installed)
    .map(([name, _]) => name);

  if (missing.length > 0) {
    console.log(chalk.yellow.bold('\nüí° Instru√ß√µes de instala√ß√£o:'));
    
    if (missing.includes('supabase_cli')) {
      console.log(chalk.gray('  - Supabase CLI: npm install -g supabase'));
    }
    
    if (missing.includes('pg_dump')) {
      console.log(chalk.gray('  - PostgreSQL: https://www.postgresql.org/download/'));
    }
  }
}

/**
 * Verificar configura√ß√£o atual
 */
function checkCurrentConfig() {
  const config = supabaseUtils.loadConfig();
  const hasCredentials = supabaseUtils.hasCredentials();
  
  console.log(chalk.blue.bold('\n‚öôÔ∏è  Configura√ß√£o Atual:\n'));
  
  if (config) {
    console.log(chalk.green('‚úÖ Arquivo de configura√ß√£o encontrado'));
    console.log(chalk.gray(`   - Localiza√ß√£o: ${require('os').homedir()}/.smoonbrc`));
    
    if (config.supabase?.url) {
      console.log(chalk.gray(`   - Supabase URL: ${config.supabase.url}`));
    }
    
    if (config.supabase?.serviceKey) {
      console.log(chalk.gray('   - Service Key: Configurada'));
    }
    
    if (config.supabase?.anonKey) {
      console.log(chalk.gray('   - Anon Key: Configurada'));
    }
  } else {
    console.log(chalk.yellow('‚ö†Ô∏è  Arquivo de configura√ß√£o n√£o encontrado'));
    console.log(chalk.gray('   - Use: smoonb config --init'));
  }
  
  if (hasCredentials) {
    console.log(chalk.green('‚úÖ Credenciais configuradas'));
  } else {
    console.log(chalk.yellow('‚ö†Ô∏è  Credenciais n√£o configuradas'));
    console.log(chalk.gray('   - Configure SUPABASE_URL e SUPABASE_ANON_KEY'));
  }
}

/**
 * Informa√ß√µes de diagn√≥stico completo
 */
function showDiagnostics() {
  showBetaBanner();
  showPrerequisitesStatus();
  checkCurrentConfig();
  showLicenseInfo();
}

/**
 * Exportar todos os m√≥dulos
 */
module.exports = {
  // Informa√ß√µes do pacote
  packageInfo,
  
  // Comandos
  commands: {
    backup: backupCommand,
    restore: restoreCommand,
    functions: functionsCommand,
    check: checkCommand,
    config: configCommand
  },
  
  // Utilit√°rios
  utils: {
    supabase: supabaseUtils,
    validation: validationUtils
  },
  
  // Fun√ß√µes de utilidade
  showBetaBanner,
  showLicenseInfo,
  showQuickHelp,
  checkPrerequisites,
  showPrerequisitesStatus,
  checkCurrentConfig,
  showDiagnostics
};
