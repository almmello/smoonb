const path = require('path');
const fs = require('fs');
const chalk = require('chalk');
const { confirm } = require('../../../utils/prompt');

/**
 * Etapa 1: Perguntar quais componentes restaurar
 */
module.exports = async (backupPath) => {
  // Database (sempre dispon√≠vel)
  const restoreDatabase = await confirm('Deseja restaurar Database', true);
  
  // Edge Functions
  const edgeFunctionsDir = path.join(backupPath, 'edge-functions');
  let restoreEdgeFunctions = false;
  if (fs.existsSync(edgeFunctionsDir) && fs.readdirSync(edgeFunctionsDir).length > 0) {
    console.log(chalk.cyan('\n‚ö° Edge Functions:'));
    console.log(chalk.gray('   As Edge Functions ser√£o copiadas para supabase/functions e implantadas no projeto destino.'));
    console.log(chalk.gray('   A pasta supabase/functions ser√° limpa antes do processo.\n'));
    restoreEdgeFunctions = await confirm('Deseja restaurar Edge Functions', true);
  }
  
  // Auth Settings
  let restoreAuthSettings = false;
  if (fs.existsSync(path.join(backupPath, 'auth-settings.json'))) {
    console.log(chalk.cyan('\nüîê Auth Settings:'));
    console.log(chalk.gray('   As configura√ß√µes de Auth ser√£o exibidas para configura√ß√£o manual no Dashboard.'));
    console.log(chalk.gray('   Algumas configura√ß√µes n√£o podem ser aplicadas automaticamente por quest√µes de seguran√ßa.\n'));
    restoreAuthSettings = await confirm('Deseja ver as configura√ß√µes de Auth Settings', true);
  }
  
  // Storage Buckets
  const storageDir = path.join(backupPath, 'storage');
  let restoreStorage = false;
  if (fs.existsSync(storageDir) && fs.readdirSync(storageDir).length > 0) {
    console.log(chalk.cyan('\nüì¶ Storage:'));
    console.log(chalk.gray('   As informa√ß√µes dos buckets de Storage ser√£o exibidas para migra√ß√£o manual.'));
    console.log(chalk.gray('   Os arquivos precisam ser migrados manualmente usando as ferramentas do Supabase.\n'));
    restoreStorage = await confirm('Deseja ver informa√ß√µes de Storage Buckets', true);
  }
  
  // Database Extensions and Settings
  const dbSettingsFiles = fs.readdirSync(backupPath)
    .filter(file => file.startsWith('database-settings-') && file.endsWith('.json'));
  let restoreDatabaseSettings = false;
  if (dbSettingsFiles.length > 0) {
    console.log(chalk.cyan('\nüîß Database Extensions and Settings:'));
    console.log(chalk.gray('   As extens√µes e configura√ß√µes do banco de dados ser√£o restauradas via SQL.'));
    console.log(chalk.gray('   Isso inclui extens√µes PostgreSQL e configura√ß√µes espec√≠ficas do projeto.\n'));
    restoreDatabaseSettings = await confirm('Deseja restaurar Database Extensions and Settings', true);
  }
  
  // Realtime Settings
  let restoreRealtimeSettings = false;
  if (fs.existsSync(path.join(backupPath, 'realtime-settings.json'))) {
    console.log(chalk.cyan('\nüîÑ Realtime Settings:'));
    console.log(chalk.gray('   As configura√ß√µes de Realtime ser√£o exibidas para configura√ß√£o manual no Dashboard.'));
    console.log(chalk.gray('   Algumas configura√ß√µes precisam ser aplicadas manualmente.\n'));
    restoreRealtimeSettings = await confirm('Deseja ver as configura√ß√µes de Realtime Settings', true);
  }
  
  return {
    database: restoreDatabase,
    edgeFunctions: restoreEdgeFunctions,
    storage: restoreStorage,
    authSettings: restoreAuthSettings,
    databaseSettings: restoreDatabaseSettings,
    realtimeSettings: restoreRealtimeSettings
  };
};

