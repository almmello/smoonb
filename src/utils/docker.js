const { exec } = require('child_process');
const { promisify } = require('util');

const execAsync = promisify(exec);

/**
 * Detecta se Docker Desktop est√° instalado no sistema
 * @returns {Promise<{installed: boolean, running: boolean}>}
 */
async function detectDockerInstallation() {
  try {
    // Tentar executar docker --version
    await execAsync('docker --version');
    return { installed: true, running: false }; // Instalado mas n√£o sabemos se est√° rodando
  } catch (error) {
    return { installed: false, running: false };
  }
}

/**
 * Verifica se Docker est√° rodando e acess√≠vel
 * @returns {Promise<boolean>}
 */
async function detectDockerRunning() {
  try {
    // Tentar executar docker ps
    await execAsync('docker ps');
    return true;
  } catch (error) {
    return false;
  }
}

/**
 * Verifica se Supabase CLI est√° dispon√≠vel
 * @returns {Promise<boolean>}
 */
async function detectSupabaseCLI() {
  try {
    // Tentar executar supabase --version
    await execAsync('supabase --version');
    return true;
  } catch (error) {
    return false;
  }
}

/**
 * Fun√ß√£o principal para detectar todas as depend√™ncias do Docker
 * @returns {Promise<{dockerInstalled: boolean, dockerRunning: boolean, supabaseCLI: boolean}>}
 */
async function detectDockerDependencies() {
  console.log('üîç Verificando depend√™ncias para backup de Edge Functions...');
  
  const dockerInstalled = await detectDockerInstallation();
  const dockerRunning = dockerInstalled.installed ? await detectDockerRunning() : false;
  const supabaseCLI = await detectSupabaseCLI();
  
  return {
    dockerInstalled: dockerInstalled.installed,
    dockerRunning,
    supabaseCLI
  };
}

module.exports = {
  detectDockerInstallation,
  detectDockerRunning,
  detectSupabaseCLI,
  detectDockerDependencies
};
