const readline = require('readline');
const fs = require('fs').promises;
const path = require('path');

/**
 * Captura configura√ß√µes de Realtime Settings interativamente
 * @param {string} projectId - ID do projeto Supabase
 * @param {string} backupDir - Diret√≥rio do backup atual
 * @param {boolean} skipInteractive - Se deve pular a etapa interativa
 * @returns {Promise<Object>} Configura√ß√µes capturadas
 */
async function captureRealtimeSettings(projectId, backupDir, skipInteractive = false) {
  const settingsFile = path.join(backupDir, 'realtime-settings.json');
  const dashboardUrl = `https://supabase.com/dashboard/project/${projectId}/realtime/settings`;
  
  // Tentar ler configura√ß√µes de backup anterior
  const previousSettings = await getPreviousRealtimeSettings(backupDir);
  
  if (skipInteractive && previousSettings) {
    console.log('üìã Copiando Realtime Settings do backup anterior...');
    await fs.writeFile(settingsFile, JSON.stringify(previousSettings, null, 2));
    return previousSettings;
  }
  
  if (previousSettings && !skipInteractive) {
    const shouldReuse = await askToReusePreviousSettings();
    if (shouldReuse) {
      console.log('üìã Reutilizando configura√ß√µes de Realtime Settings do backup anterior...');
      await fs.writeFile(settingsFile, JSON.stringify(previousSettings, null, 2));
      return previousSettings;
    }
  }
  
  // Capturar configura√ß√µes interativamente
  console.log('\nüîß Configura√ß√µes de Realtime Settings');
  console.log('‚ïê'.repeat(50));
  console.log(`üì± Acesse: ${dashboardUrl}`);
  console.log('üìù Anote os valores dos 4 par√¢metros abaixo:\n');
  
  const settings = await captureSettingsInteractively(projectId, previousSettings);
  
  // Salvar configura√ß√µes
  await fs.writeFile(settingsFile, JSON.stringify(settings, null, 2));
  console.log('\n‚úÖ Configura√ß√µes de Realtime Settings salvas!');
  
  return settings;
}

/**
 * Busca configura√ß√µes de backup anterior
 * @param {string} backupDir - Diret√≥rio do backup atual
 * @returns {Promise<Object|null>} Configura√ß√µes anteriores ou null
 */
async function getPreviousRealtimeSettings(backupDir) {
  try {
    // Buscar em backups anteriores
    const backupsDir = path.dirname(backupDir);
    const entries = await fs.readdir(backupsDir, { withFileTypes: true });
    const backupDirs = entries
      .filter(entry => entry.isDirectory() && entry.name.startsWith('backup-'))
      .map(entry => entry.name)
      .sort()
      .reverse(); // Mais recente primeiro
    
    for (const backupName of backupDirs) {
      const settingsPath = path.join(backupsDir, backupName, 'realtime-settings.json');
      try {
        const content = await fs.readFile(settingsPath, 'utf8');
        const settings = JSON.parse(content);
        if (settings.realtime_settings && settings.realtime_settings.settings) {
          return settings;
        }
      } catch {
        // Continuar para pr√≥ximo backup
        continue;
      }
    }
    
    return null;
  } catch {
    return null;
  }
}

/**
 * Pergunta se deve reutilizar configura√ß√µes anteriores
 * @returns {Promise<boolean>} true se deve reutilizar
 */
async function askToReusePreviousSettings() {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });
  
  return new Promise((resolve) => {
    rl.question('üîÑ Foi identificada uma grava√ß√£o anterior de Realtime Settings.\n   Deseja reutilizar as configura√ß√µes anteriores? (S/n): ', (answer) => {
      rl.close();
      const shouldReuse = !answer.toLowerCase().startsWith('n');
      resolve(shouldReuse);
    });
  });
}

/**
 * Captura configura√ß√µes interativamente via perguntas
 * @param {string} projectId - ID do projeto Supabase
 * @param {Object} previousSettings - Configura√ß√µes anteriores para usar como padr√£o
 * @returns {Promise<Object>} Configura√ß√µes capturadas
 */
async function captureSettingsInteractively(projectId, previousSettings) {
  const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
  });
  
  const askQuestion = (question, defaultValue) => {
    return new Promise((resolve) => {
      rl.question(`${question} [${defaultValue}]: `, (answer) => {
        resolve(answer.trim() || defaultValue);
      });
    });
  };
  
  try {
    console.log('üìã Responda as perguntas abaixo (pressione Enter para usar o valor padr√£o):\n');
    
    // Valores padr√£o baseados na imagem ou configura√ß√µes anteriores
    const defaults = previousSettings?.realtime_settings?.settings || {
      allow_public_access: { value: true },
      database_connection_pool_size: { value: 2 },
      max_concurrent_clients: { value: 200 },
      max_events_per_second: { value: 100 }
    };
    
    const allowPublicAccess = await askQuestion(
      '1. Allow public access (true/false):',
      defaults.allow_public_access.value
    );
    
    const poolSize = await askQuestion(
      '2. Database connection pool size:',
      defaults.database_connection_pool_size.value
    );
    
    const maxClients = await askQuestion(
      '3. Max concurrent clients:',
      defaults.max_concurrent_clients.value
    );
    
    const maxEvents = await askQuestion(
      '4. Max events per second:',
      defaults.max_events_per_second.value
    );
    
    const settings = {
      realtime_settings: {
        note: "Configura√ß√µes de Realtime Settings capturadas interativamente",
        dashboard_url: `https://supabase.com/dashboard/project/${projectId}/realtime/settings`,
        captured_at: new Date().toISOString(),
        settings: {
          allow_public_access: {
            label: "Allow public access",
            description: "If disabled, only private channels will be allowed",
            value: allowPublicAccess === 'true' || allowPublicAccess === true
          },
          database_connection_pool_size: {
            label: "Database connection pool size",
            description: "Realtime Authorization uses this database pool to check client access",
            value: parseInt(poolSize)
          },
          max_concurrent_clients: {
            label: "Max concurrent clients", 
            description: "Sets maximum number of concurrent clients that can connect to your Realtime service",
            value: parseInt(maxClients)
          },
          max_events_per_second: {
            label: "Max events per second",
            description: "Sets maximum number of events per second that can be sent to your Realtime service",
            value: parseInt(maxEvents)
          }
        },
        restore_instructions: {
          url: `https://supabase.com/dashboard/project/${projectId}/realtime/settings`,
          steps: [
            "1. Acesse a URL acima",
            "2. Configure 'Allow public access' conforme o valor em settings.allow_public_access.value",
            "3. Configure 'Database connection pool size' conforme o valor em settings.database_connection_pool_size.value",
            "4. Configure 'Max concurrent clients' conforme o valor em settings.max_concurrent_clients.value", 
            "5. Configure 'Max events per second' conforme o valor em settings.max_events_per_second.value",
            "6. Clique em 'Save changes'"
          ]
        }
      }
    };
    
    return settings;
    
  } finally {
    rl.close();
  }
}

module.exports = {
  captureRealtimeSettings
};
